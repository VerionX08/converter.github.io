<script>
let retryCount = 0;
const MAX_RETRY = 10;

async function convert() {
  const input = document.getElementById("asset").value.trim();
  if (!input) return;

  const id = input.replace("rbxassetid://", "");
  const status = document.getElementById("status");
  const img = document.getElementById("img");
  const link = document.getElementById("link");

  retryCount = 0;
  img.style.display = "none";
  link.innerText = "";

  checkAsset(id);

  async function checkAsset(assetId) {
    try {
      status.innerText = `ğŸ” Äang kiá»ƒm tra asset (${retryCount}/${MAX_RETRY})`;

      const api = `https://thumbnails.roblox.com/v1/assets?assetIds=${assetId}&size=420x420&format=Png`;
      const res = await fetch(api);
      const json = await res.json();

      if (!json.data || !json.data[0]) {
        status.innerText = "âŒ KhÃ´ng tÃ¬m tháº¥y asset";
        return;
      }

      const data = json.data[0];

      // â³ Pending â†’ retry
      if (data.state === "Pending") {
        retryCount++;
        if (retryCount >= MAX_RETRY) {
          status.innerText = "â° Pending quÃ¡ lÃ¢u, thá»­ láº¡i sau";
          return;
        }
        setTimeout(() => checkAsset(assetId), 2000);
        return;
      }

      // âŒ Blocked / lá»—i
      if (data.state !== "Completed" || !data.imageUrl) {
        status.innerText = `âŒ Asset khÃ´ng kháº£ dá»¥ng (${data.state})`;
        return;
      }

      // âœ… ThÃ nh cÃ´ng
      img.src = data.imageUrl;
      img.style.display = "block";
      link.innerText = data.imageUrl;
      status.innerText = "âœ… Asset sáºµn sÃ ng";

    } catch (e) {
      status.innerText = "âŒ Lá»—i khi gá»i API";
    }
  }
}
</script>
